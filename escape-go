#!/bin/sh

# Defaults.
: ${Check:=check} ${Escape:=escape}

Working=$(pwd)

Hatches=$(find "$Working" -name '*.ego' |
while read Path; do
	Generated=$(echo "$Path" | sed -e 's/\.ego/.go/g')
	"$Escape" "$Path" > "$Generated" &&
	grep -Hn 'escape_hatch.*generated by escape' "$Generated"
done)

Pattern=$(echo "$Hatches" | cut -d: -f-2 | tr : ' ' |
"$Check" -algo=pta -test . |
cut -d: -f-2 | tr '\n' '|' | sed 's/.$//')

Errors=$(echo "$Hatches" | grep -E "$Pattern" |
sed -e 's/.* generated by escape: //g' |
sed -re 's/[^:]+$/ problem with escape()/g' |
sed -e "s|${Working}/||g")

if [ -n "$Errors" ]; then
	echo "$Errors" >&2
	exit 1
fi

exit 0
